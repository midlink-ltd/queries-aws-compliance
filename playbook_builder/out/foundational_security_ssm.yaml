connections:
  aws: ''
desc: ''
name: '"foundational_security_ssm"'
steps:
- desc: example description delete afterwards
  text: '#3 Instances managed by Systems Manager should have an association compliance
    status of COMPLIANT'
- action: core.sql
  desc: Description
  id: S1
  inputs:
    sql: " \n select\n  -- Required Columns\n  id as resource,\n  case\n    when c.status\
      \ = 'COMPLIANT' then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when\
      \ c.status = 'COMPLIANT' then c.resource_id || ' association ' || c.title ||\
      \ ' is compliant.'\n    else c.resource_id || ' association ' || c.title ||\
      \ ' is non-compliant.'\n  end as reason,\n  -- Additional Dimensions\n  c.region,\n\
      \  c.account_id\nfrom\n  aws_ssm_managed_instance as i,\n  aws_ssm_managed_instance_compliance\
      \ as c\nwhere\n  c.resource_id = i.instance_id\n  and c.compliance_type = 'Association';"
  name: Perform the query
- action: slack.SendFile
  connections:
    slack: slack_connection
  desc: Description
  id: S2
  inputs:
    Channel: demo
    Content: '{{table_to_csv(steps.S1.output)}}'
    File name: ''
    File type: csv
  name: Send report to Slack
- desc: example description delete afterwards
  text: '#3 Instances managed by Systems Manager should have an association compliance
    status of COMPLIANT'
- action: core.sql
  desc: Description
  id: S3
  inputs:
    sql: " \n select\n  -- Required Columns\n  id as resource,\n  case\n    when c.status\
      \ = 'COMPLIANT' then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when\
      \ c.status = 'COMPLIANT' then c.resource_id || ' association ' || c.title ||\
      \ ' is compliant.'\n    else c.resource_id || ' association ' || c.title ||\
      \ ' is non-compliant.'\n  end as reason,\n  -- Additional Dimensions\n  c.region,\n\
      \  c.account_id\nfrom\n  aws_ssm_managed_instance as i,\n  aws_ssm_managed_instance_compliance\
      \ as c\nwhere\n  c.resource_id = i.instance_id\n  and c.compliance_type = 'Association';"
  name: Perform the query
- action: slack.SendFile
  connections:
    slack: slack_connection
  desc: Description
  id: S4
  inputs:
    Channel: demo
    Content: '{{table_to_csv(steps.S3.output)}}'
    File name: ''
    File type: csv
  name: Send report to Slack
- desc: example description delete afterwards
  text: '#3 Instances managed by Systems Manager should have an association compliance
    status of COMPLIANT'
- action: core.sql
  desc: Description
  id: S5
  inputs:
    sql: " \n select\n  -- Required Columns\n  id as resource,\n  case\n    when c.status\
      \ = 'COMPLIANT' then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when\
      \ c.status = 'COMPLIANT' then c.resource_id || ' association ' || c.title ||\
      \ ' is compliant.'\n    else c.resource_id || ' association ' || c.title ||\
      \ ' is non-compliant.'\n  end as reason,\n  -- Additional Dimensions\n  c.region,\n\
      \  c.account_id\nfrom\n  aws_ssm_managed_instance as i,\n  aws_ssm_managed_instance_compliance\
      \ as c\nwhere\n  c.resource_id = i.instance_id\n  and c.compliance_type = 'Association';"
  name: Perform the query
- action: slack.SendFile
  connections:
    slack: slack_connection
  desc: Description
  id: S6
  inputs:
    Channel: demo
    Content: '{{table_to_csv(steps.S5.output)}}'
    File name: ''
    File type: csv
  name: Send report to Slack
tags: []
type: Flow
